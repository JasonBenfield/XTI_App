using NUnit.Framework;
using XTI_Core;
using XTI_WebAppClient;

namespace XTI_WebApp.Tests;

internal sealed class DeserializedWebErrorResultTest
{
    [Test]
    public void ShouldDeserializeWebErrorResult()
    {
        var result = new DeserializedWebErrorResult
        (
            """
            {"Data":{"LogEntryKey":"347b916658954617a837b24f1e92eaff","Severity":{"Value":70,"DisplayText":"App Error"},"Errors":[{"Message":"   at XTI_Hub.AppUserRepository.UserByExternalKey(AuthenticatorKey authenticatorKey, String externalUserKey) in C:\\XTI\\src\\JasonBenfield\\HubWebApp\\HubWebApp\\Internal\\XTI_Hub\\AppUserRepository.cs:line 150\r\n   at XTI_HubWebAppApi.ExternalAuth.ExternalAuthKeyAction.Execute(ExternalAuthKeyModel model, CancellationToken stoppingToken) in C:\\XTI\\src\\JasonBenfield\\HubWebApp\\HubWebApp\\Internal\\XTI_HubWebAppApi\\ExternalAuth\\ExternalAuthKeyAction.cs:line 17\r\n   at XTI_App.Api.AppApiAction\u00602.Execute(TModel model, CancellationToken stoppingToken)\r\n   at lambda_method1326(Closure, Object)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.AwaitableObjectResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeActionMethodAsync\u003Eg__Awaited|12_0(ControllerActionInvoker invoker, ValueTask\u00601 actionResultValueTask)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeNextActionFilterAsync\u003Eg__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State\u0026 next, Scope\u0026 scope, Object\u0026 state, Boolean\u0026 isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeInnerFilterAsync\u003Eg__Awaited|13_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeNextResourceFilter\u003Eg__Awaited|25_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Rethrow(ResourceExecutedContextSealed context)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Next(State\u0026 next, Scope\u0026 scope, Object\u0026 state, Boolean\u0026 isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeFilterPipelineAsync\u003Eg__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeAsync\u003Eg__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeAsync\u003Eg__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Routing.EndpointMiddleware.\u003CInvoke\u003Eg__AwaitRequestTask|6_0(Endpoint endpoint, Task requestTask, ILogger logger)\r\n   at XTI_WebApp.Extensions.SessionLogMiddleware.InvokeAsync(HttpContext context, CurrentSession currentSession, TempLogSession tempLogSession, IAnonClient anonClient, IClock clock, XtiRequestContext xtiRequestContext)","Caption":"External User not found","Source":""}]}}
            """
        ).Value;
        Assert.That(result.LogEntryKey, Is.EqualTo("347b916658954617a837b24f1e92eaff"));
        Assert.That(result.Severity, Is.EqualTo(AppEventSeverity.Values.AppError));
        Assert.That(result.Errors.Length, Is.EqualTo(1));
    }

    [Test]
    public void ShouldDeserializeErrors()
    {
        var result = new DeserializedWebErrorResult
        (
            """
            {"Data":[{"Message":"   at XTI_Hub.AppUserRepository.UserByExternalKey(AuthenticatorKey authenticatorKey, String externalUserKey) in C:\\XTI\\src\\JasonBenfield\\HubWebApp\\HubWebApp\\Internal\\XTI_Hub\\AppUserRepository.cs:line 150\r\n   at XTI_HubWebAppApi.ExternalAuth.ExternalAuthKeyAction.Execute(ExternalAuthKeyModel model, CancellationToken stoppingToken) in C:\\XTI\\src\\JasonBenfield\\HubWebApp\\HubWebApp\\Internal\\XTI_HubWebAppApi\\ExternalAuth\\ExternalAuthKeyAction.cs:line 17\r\n   at XTI_App.Api.AppApiAction\u00602.Execute(TModel model, CancellationToken stoppingToken)\r\n   at lambda_method1326(Closure, Object)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.AwaitableObjectResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeActionMethodAsync\u003Eg__Awaited|12_0(ControllerActionInvoker invoker, ValueTask\u00601 actionResultValueTask)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeNextActionFilterAsync\u003Eg__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State\u0026 next, Scope\u0026 scope, Object\u0026 state, Boolean\u0026 isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeInnerFilterAsync\u003Eg__Awaited|13_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeNextResourceFilter\u003Eg__Awaited|25_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Rethrow(ResourceExecutedContextSealed context)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Next(State\u0026 next, Scope\u0026 scope, Object\u0026 state, Boolean\u0026 isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeFilterPipelineAsync\u003Eg__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeAsync\u003Eg__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeAsync\u003Eg__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Routing.EndpointMiddleware.\u003CInvoke\u003Eg__AwaitRequestTask|6_0(Endpoint endpoint, Task requestTask, ILogger logger)\r\n   at XTI_WebApp.Extensions.SessionLogMiddleware.InvokeAsync(HttpContext context, CurrentSession currentSession, TempLogSession tempLogSession, IAnonClient anonClient, IClock clock, XtiRequestContext xtiRequestContext)","Caption":"External User not found","Source":""}]}
            """
        ).Value;
        Assert.That(result.LogEntryKey, Is.EqualTo(""));
        Assert.That(result.Severity, Is.EqualTo(AppEventSeverity.Values.CriticalError));
        Assert.That(result.Errors.Length, Is.EqualTo(1));
        Assert.That(result.Errors[0].Caption, Is.EqualTo("External User not found"));
        Assert.That(result.Errors[0].Message, Is.EqualTo("   at XTI_Hub.AppUserRepository.UserByExternalKey(AuthenticatorKey authenticatorKey, String externalUserKey) in C:\\XTI\\src\\JasonBenfield\\HubWebApp\\HubWebApp\\Internal\\XTI_Hub\\AppUserRepository.cs:line 150\r\n   at XTI_HubWebAppApi.ExternalAuth.ExternalAuthKeyAction.Execute(ExternalAuthKeyModel model, CancellationToken stoppingToken) in C:\\XTI\\src\\JasonBenfield\\HubWebApp\\HubWebApp\\Internal\\XTI_HubWebAppApi\\ExternalAuth\\ExternalAuthKeyAction.cs:line 17\r\n   at XTI_App.Api.AppApiAction\u00602.Execute(TModel model, CancellationToken stoppingToken)\r\n   at lambda_method1326(Closure, Object)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.AwaitableObjectResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeActionMethodAsync\u003Eg__Awaited|12_0(ControllerActionInvoker invoker, ValueTask\u00601 actionResultValueTask)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeNextActionFilterAsync\u003Eg__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State\u0026 next, Scope\u0026 scope, Object\u0026 state, Boolean\u0026 isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeInnerFilterAsync\u003Eg__Awaited|13_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeNextResourceFilter\u003Eg__Awaited|25_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Rethrow(ResourceExecutedContextSealed context)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.Next(State\u0026 next, Scope\u0026 scope, Object\u0026 state, Boolean\u0026 isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeFilterPipelineAsync\u003Eg__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeAsync\u003Eg__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeAsync\u003Eg__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Routing.EndpointMiddleware.\u003CInvoke\u003Eg__AwaitRequestTask|6_0(Endpoint endpoint, Task requestTask, ILogger logger)\r\n   at XTI_WebApp.Extensions.SessionLogMiddleware.InvokeAsync(HttpContext context, CurrentSession currentSession, TempLogSession tempLogSession, IAnonClient anonClient, IClock clock, XtiRequestContext xtiRequestContext)"));
    }
}
